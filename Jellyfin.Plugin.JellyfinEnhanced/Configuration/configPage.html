<!DOCTYPE html>
<html lang="en">
<head>
    <title>Jellyfin Enhanced</title>
</head>
<body>
<div class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-checkbox,emby-select" data-role="page" id="JellyfinEnhancedPage" style="color: #eee;">
    <div data-role="content">
        <div class="content-primary">
            <div class="verticalSection">
                <div class="sectionTitleContainer">
                     <h2 class="sectionTitle">Jellyfin Enhanced</h2>
                        <a is="emby-linkbutton" class="raised raised-mini emby-button" style="margin-left: 2em;" target="_blank" href="https://github.com/n00bcodr/Jellyfin-Enhanced">
                            <i class="md-icon button-icon button-icon-left secondaryText"></i>
                            <span>Help</span>
                        </a>
                </div>
            </div>
            <hr>

            <div style="margin-bottom: 1em;">
                <button class="jellyfin-tab-button active" data-tab="enhanced" style="background: none; border: none; color: var(--primary-accent-color, #fff); cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid var(--primary-accent-color, #fff);"><h3>Enhanced Settings</h3></button>
                <button class="jellyfin-tab-button" data-tab="elsewhere" style="background: none; border: none; color: #ccc; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid transparent;"><h3>Elsewhere Settings</h3></button>
            </div>
            <form id="JellyfinEnhancedForm">
                <div id="enhanced" class="jellyfin-tab-content active" style="display: block; font-family: inherit;">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Default User Settings</h3></legend>
                        <aside>‚ÑπÔ∏è Changes only take effect when all the existing settings are Reset.</aside>
                        <br><br>
                        <div class="configSection">
                            <details style="margin-bottom: 1em; background-color: rgba(255,255,255,0.05); padding: 1em; border-radius: 5px;">
                                <summary style="cursor: pointer; font-weight: bold;">‚èØÔ∏è Playback Settings</summary>
                                <div style="padding-top: 1em;">
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="autoPauseEnabled" is="emby-checkbox" type="checkbox"/><span>Auto-pause on tab switch</span></label></div>
                                    <div class="checkboxContainer"><label><input id="autoResumeEnabled" is="emby-checkbox" type="checkbox"/><span>Auto-resume on tab switch</span></label></div>
                                </div>
                            </details>
                            <details style="margin-bottom: 1em; background-color: rgba(255,255,255,0.05); padding: 1em; border-radius: 5px;">
                                <summary style="cursor: pointer; font-weight: bold;">‚Ü™Ô∏è Auto-Skip Settings</summary>
                                <div style="padding-top: 1em;">
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="autoSkipIntro" is="emby-checkbox" type="checkbox"/><span>Auto-skip Intro</span></label></div>
                                    <div class="checkboxContainer"><label><input id="autoSkipOutro" is="emby-checkbox" type="checkbox"/><span>Auto-skip Outro</span></label></div>
                                </div>
                            </details>
                            <details style="margin-bottom: 1em; background-color: rgba(255,255,255,0.05); padding: 1em; border-radius: 5px;">
                                <summary style="cursor: pointer; font-weight: bold;">üé≤ Random Button Settings</summary>
                                <div style="padding-top: 1em;">
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="randomButtonEnabled" is="emby-checkbox" type="checkbox"/><span>Enable Random Button</span></label></div>
                                    <div class="checkboxContainer"><label><input id="randomUnwatchedOnly" is="emby-checkbox" type="checkbox"/><span>Show unwatched only in random selection</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="randomIncludeMovies" is="emby-checkbox" type="checkbox"/><span>Include movies in random selection</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="randomIncludeShows" is="emby-checkbox" type="checkbox"/><span>Include shows in random selection</span></label></div>
                                </div>
                            </details>
                            <details style="margin-bottom: 1em; background-color: rgba(255,255,255,0.05); padding: 1em; border-radius: 5px;">
                                <summary style="cursor: pointer; font-weight: bold;">üñ•Ô∏è UI Settings</summary>
                                <div style="padding-top: 1em;">
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="showFileSizes" is="emby-checkbox" type="checkbox"/><span>Show file sizes</span></label></div>
                                    <div class="checkboxContainer"><label><input id="removeContinueWatchingEnabled" is="emby-checkbox" type="checkbox"/><span>Enable "Remove from Continue Watching"</span></label></div>
                                </div>
                            </details>
                        </div>
                    </fieldset>
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Shortcut Overrides</h3></legend>
                        <div style="margin-bottom: 2em; padding-bottom: 1.5em; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <h4 class="sectionTitle" style="margin-top: 0;">Add Override</h4>
                            <div style="display: flex; gap: 1em; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <select is="emby-select" id="add-shortcut-select" label="Shortcut Action"></select>
                                </div>
                                <div style="flex: 1;">
                                    <input is="emby-input" id="add-shortcut-key" type="text" label="New Key"/>
                                </div>
                                <button is="emby-button" type="button" id="add-shortcut-btn" class="raised button-submit" style="top: 10px;">
                                    <span>Add</span>
                                </button>
                            </div>
                            <div id="shortcut-error-comment" style="display: none; color: #ffdddd; font-size: 0.9em; margin-top: 0.75em; background-color: rgba(220, 53, 69, 0.2); padding: 0.5em; border-radius: 4px; border-left: 3px solid #dc3545;"></div>
                            <p class="fieldDescription" style="margin-top: 1em;">
                                <b>Modifier Keys:</b> Use `Shift+`, `Ctrl+`, or `Alt+`. Examples: `Shift+A`, `Ctrl+S`.
                            </p>
                        </div>
                        <p class="fieldDescription">Only custom shortcut overrides are displayed below. All other shortcuts will use default values.</p>
                        <div id="shortcut-list-container" style="display: flex; flex-direction: column; gap: 0.75em; margin-top: 1em;">
                            </div>
                    </fieldset>
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Timeout Settings</h3></legend>
                        <div class="configSection">
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="HelpPanelAutocloseDelay">Help Panel Autoclose Delay (in milliseconds)</label>
                                <input id="HelpPanelAutocloseDelay" is="emby-input" name="HelpPanelAutocloseDelay" type="number"/>
                                <div class="fieldDescription">How long the help panel stays open before auto-closing.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="ToastDuration">Toast Duration (in milliseconds)</label>
                                <input id="ToastDuration" is="emby-input" name="ToastDuration" type="number"/>
                                <div class="fieldDescription">How long toast notifications are displayed.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="ClearBookmarksDelay">Clear Bookmarks Delay (in milliseconds)</label>
                                <input id="ClearBookmarksDelay" is="emby-input" name="ClearBookmarksDelay" type="number"/>
                                <div class="fieldDescription">How long to hold Shift+B to clear all bookmarks.</div>
                            </div>
                        </div>
                    </fieldset>


                    <div class="verticalSection">
                        <button id="clearLocalStorageBtn" class="raised button-cancel block emby-button" is="emby-button" type="button">
                            <span>Reset Settings for all users</span>
                        </button>
                    </div>
                </div>

                <div id="elsewhere" class="jellyfin-tab-content" style="display: none; font-family: inherit;">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Configuration</h3></legend>
                        <div class="configSection">
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="TMDB_API_KEY">TMDB API Key</label>
                                <input id="TMDB_API_KEY" is="emby-input" name="TMDB_API_KEY" type="text"/>
                                <div class="fieldDescription">Your API key from The Movie DB (TMDB). <a class="sectionTitle" target="_blank" href="https://www.themoviedb.org/settings/api">How to?</a></div>
                                <div class="fieldDescription">Leaving this blank will not load Jellyfin Elsewhere</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="DEFAULT_REGION">Default Region</label>
                                <input id="DEFAULT_REGION" is="emby-input" name="DEFAULT_REGION" type="text" placeholder="e.g., US"/>
                                <div class="fieldDescription">The default two-letter country code for streaming provider lookup. Empty defaults to US. <a class="sectionTitle" target="_blank" href="https://raw.githubusercontent.com/n00bcodr/Jellyfin-Elsewhere/refs/heads/main/resources/regions.txt">Full List</a></div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="DEFAULT_PROVIDERS">Default Providers</label>
                                <textarea style="display:block; height: 10vh !important;" class="emby-textarea emby-input" id="DEFAULT_PROVIDERS" name="DEFAULT_PROVIDERS" placeholder="e.g., Netflix,Hulu"></textarea>
                                <div class="fieldDescription">A list of default streaming providers to show. Leave blank to show all. <a class="sectionTitle" target="_blank" href="https://raw.githubusercontent.com/n00bcodr/Jellyfin-Elsewhere/refs/heads/main/resources/providers.txt">Full List</a></div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="IGNORE_PROVIDERS">Ignore Providers</label>
                                <textarea style="display:block; height: 10vh !important;" class="emby-textarea emby-input" id="IGNORE_PROVIDERS" name="IGNORE_PROVIDERS" placeholder="e.g., .*with Ads, Hulu"></textarea>
                                <div class="fieldDescription">A list of providers to ignore from the default region (supports regex).<a class="sectionTitle" target="_blank" href="https://raw.githubusercontent.com/n00bcodr/Jellyfin-Elsewhere/refs/heads/main/resources/providers.txt">Full List</a></div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <br>
                <div>
                    <button class="raised button-submit block emby-button" is="emby-button" type="submit">
                        <span>Save</span>
                    </button>
                </div>

            </form>
        </div>
    </div>
<script type="text/javascript">
        (() => {
            const pluginId = 'f69e946a-4b3c-4e9a-8f0a-8d7c1b2c4d9b';
            const page = document.querySelector('#JellyfinEnhancedPage');
            const form = document.querySelector('#JellyfinEnhancedForm');
            const clearLocalStorageBtn = document.querySelector('#clearLocalStorageBtn');

            const shortcutListContainer = document.getElementById('shortcut-list-container');
            const addShortcutSelect = document.getElementById('add-shortcut-select');
            const addShortcutKeyInput = document.getElementById('add-shortcut-key');
            const addShortcutBtn = document.getElementById('add-shortcut-btn');
            const shortcutErrorComment = document.getElementById('shortcut-error-comment');

            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    10%, 90% { transform: translate3d(-1px, 0, 0); }
                    20%, 80% { transform: translate3d(2px, 0, 0); }
                    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
                    40%, 60% { transform: translate3d(4px, 0, 0); }
                }
                .shake {
                    animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
                }
            `;
            document.head.appendChild(style);

            let shortcutOverrides = [];

            const tabs = document.querySelectorAll('.jellyfin-tab-button');
            const tabContents = document.querySelectorAll('.jellyfin-tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.color = '#ccc';
                        t.style.borderBottom = '2px solid transparent';
                    });
                    tab.classList.add('active');
                    tab.style.color = 'var(--primary-accent-color, #fff)';
                    tab.style.borderBottom = '2px solid var(--primary-accent-color, #fff)';
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    const activeTab = document.getElementById(tab.dataset.tab)
                    activeTab.classList.add('active');
                    activeTab.style.display = 'block';
                });
            });

        const defaultShortcuts = [
            { Name: "OpenSearch", Key: "/", Label: "Open Search", Category: "Global" },
            { Name: "GoToHome", Key: "Shift+H", Label: "Go to Home", Category: "Global" },
            { Name: "GoToDashboard", Key: "D", Label: "Go to Dashboard", Category: "Global" },
            { Name: "QuickConnect", Key: "Q", Label: "Quick Connect", Category: "Global" },
            { Name: "PlayRandomItem", Key: "R", Label: "Play Random Item", Category: "Global" },
            { Name: "ClearAllBookmarks", Key: "Shift+B", Label: "Clear All Bookmarks (Hold)", Category: "Global" },
            { Name: "CycleAspectRatio", Key: "A", Label: "Cycle Aspect Ratio", Category: "Player" },
            { Name: "ShowPlaybackInfo", Key: "I", Label: "Show Playback Info", Category: "Player" },
            { Name: "SubtitleMenu", Key: "S", Label: "Subtitle Menu", Category: "Player" },
            { Name: "CycleSubtitleTracks", Key: "C", Label: "Cycle Subtitle Tracks", Category: "Player" },
            { Name: "CycleAudioTracks", Key: "V", Label: "Cycle Audio Tracks", Category: "Player" },
            { Name: "IncreasePlaybackSpeed", Key: "+", Label: "Increase Playback Speed", Category: "Player" },
            { Name: "DecreasePlaybackSpeed", Key: "-", Label: "Decrease Playback Speed", Category: "Player" },
            { Name: "ResetPlaybackSpeed", Key: "R", Label: "Reset Playback Speed", Category: "Player" },
            { Name: "BookmarkCurrentTime", Key: "B", Label: "Bookmark Current Time", Category: "Player" },
            { Name: "GoToSavedBookmark", Key: "Shift+B", Label: "Go to Saved Bookmark", Category: "Player" }
        ];

        function renderOverrides() {
            shortcutListContainer.innerHTML = '';
            if (shortcutOverrides.length === 0) {
                 shortcutListContainer.innerHTML = '<p class="fieldDescription" style="text-align: center;">No overrides configured. All shortcuts are using default values.</p>';
            }
            shortcutOverrides.forEach((shortcut, index) => {
                const row = document.createElement('div');
                row.className = 'inputContainer';
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.gap = '1em';

                const label = document.createElement('label');
                label.className = 'inputLabel';
                label.textContent = shortcut.Label;
                label.style.flex = '1';

                const input = document.createElement('input');
                input.setAttribute('is', 'emby-input');
                input.type = 'text';
                input.value = shortcut.Key;
                input.style.flex = '1';
                input.addEventListener('input', (e) => {
                    shortcutOverrides[index].Key = e.target.value;
                });

                const buttonContainer = document.createElement('div');
                const removeBtn = document.createElement('button');
                removeBtn.setAttribute('is', 'emby-button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'Remove';
                removeBtn.className = 'raised button-cancel';
                removeBtn.style.marginLeft = '1em';
                removeBtn.addEventListener('click', () => {
                    shortcutOverrides.splice(index, 1);
                    renderOverrides();
                    populateAddShortcutDropdown();
                });

                buttonContainer.appendChild(removeBtn);
                row.appendChild(label);
                row.appendChild(input);
                row.appendChild(buttonContainer);
                shortcutListContainer.appendChild(row);
            });
        }

        function populateAddShortcutDropdown() {
            addShortcutSelect.innerHTML = '';
            const overriddenNames = shortcutOverrides.map(s => s.Name);
            const availableShortcuts = defaultShortcuts.filter(s => !overriddenNames.includes(s.Name));

            availableShortcuts.forEach(shortcut => {
                const option = document.createElement('option');
                option.value = shortcut.Name;
                option.textContent = shortcut.Label;
                addShortcutSelect.appendChild(option);
            });
            addShortcutBtn.disabled = availableShortcuts.length === 0;
            addShortcutKeyInput.disabled = availableShortcuts.length === 0;
        }

        function showValidationError(elementToShake, message) {
            shortcutErrorComment.textContent = message;
            shortcutErrorComment.style.display = 'block';
            elementToShake.classList.add('shake');

            setTimeout(() => {
                elementToShake.classList.remove('shake');
                shortcutErrorComment.style.display = 'none';
            }, 8000);
        }

        addShortcutBtn.addEventListener('click', () => {
            const selectedName = addShortcutSelect.value;
            const newKey = addShortcutKeyInput.value.trim();

            if (!selectedName || !newKey) {
                showValidationError(addShortcutBtn, 'Please enter an override key.');
                return;
            }

            const isKeyInUse = shortcutOverrides.some(s => s.Key.toLowerCase() === newKey.toLowerCase());

            if (isKeyInUse) {
                showValidationError(addShortcutKeyInput.parentElement, 'The key is already assigned to another override.');
                return;
            }

            const defaultConfig = defaultShortcuts.find(s => s.Name === selectedName);
            if (defaultConfig) {
                shortcutOverrides.push({ ...defaultConfig, Key: newKey });
                renderOverrides();
                populateAddShortcutDropdown();
                addShortcutKeyInput.value = '';
            }
        });

        function loadConfig() {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(pluginId).then((config) => {
                const savedShortcuts = (config.Shortcuts && config.Shortcuts.length > 0) ? config.Shortcuts : defaultShortcuts;
                shortcutOverrides = savedShortcuts.filter(saved => {
                    const def = defaultShortcuts.find(d => d.Name === saved.Name);
                    return !def || saved.Key !== def.Key;
                });

                renderOverrides();
                populateAddShortcutDropdown();

                // Load all other settings
                document.querySelector('#ClearBookmarksDelay').value = config.ClearBookmarksDelay;
                document.querySelector('#ToastDuration').value = config.ToastDuration;
                document.querySelector('#HelpPanelAutocloseDelay').value = config.HelpPanelAutocloseDelay;
                document.querySelector('#TMDB_API_KEY').value = config.TMDB_API_KEY;
                document.querySelector('#DEFAULT_REGION').value = config.DEFAULT_REGION;
                document.querySelector('#DEFAULT_PROVIDERS').value = config.DEFAULT_PROVIDERS;
                document.querySelector('#IGNORE_PROVIDERS').value = config.IGNORE_PROVIDERS;
                document.querySelector('#autoPauseEnabled').checked = config.AutoPauseEnabled;
                document.querySelector('#autoResumeEnabled').checked = config.AutoResumeEnabled;
                document.querySelector('#autoSkipIntro').checked = config.AutoSkipIntro;
                document.querySelector('#autoSkipOutro').checked = config.AutoSkipOutro;
                document.querySelector('#randomButtonEnabled').checked = config.RandomButtonEnabled;
                document.querySelector('#randomIncludeMovies').checked = config.RandomIncludeMovies;
                document.querySelector('#randomIncludeShows').checked = config.RandomIncludeShows;
                document.querySelector('#randomUnwatchedOnly').checked = config.RandomUnwatchedOnly;
                document.querySelector('#showFileSizes').checked = config.ShowFileSizes;
                document.querySelector('#removeContinueWatchingEnabled').checked = config.RemoveContinueWatchingEnabled;

                Dashboard.hideLoadingMsg();
            });
        }

        function saveConfig(e) {
            e.preventDefault();
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(pluginId).then(config => {

                const finalShortcuts = [...defaultShortcuts];
                shortcutOverrides.forEach(override => {
                    const index = finalShortcuts.findIndex(s => s.Name === override.Name);
                    if (index !== -1) {
                        finalShortcuts[index] = override;
                    }
                });
                config.Shortcuts = finalShortcuts;

                // Save all other settings
                config.ClearBookmarksDelay = parseInt(document.querySelector('#ClearBookmarksDelay').value, 10);
                config.ToastDuration = parseInt(document.querySelector('#ToastDuration').value, 10);
                config.HelpPanelAutocloseDelay = parseInt(document.querySelector('#HelpPanelAutocloseDelay').value, 10);
                config.TMDB_API_KEY = document.querySelector('#TMDB_API_KEY').value;
                config.DEFAULT_REGION = document.querySelector('#DEFAULT_REGION').value;
                config.DEFAULT_PROVIDERS = document.querySelector('#DEFAULT_PROVIDERS').value;
                config.IGNORE_PROVIDERS = document.querySelector('#IGNORE_PROVIDERS').value;
                config.AutoPauseEnabled = document.querySelector('#autoPauseEnabled').checked;
                config.AutoResumeEnabled = document.querySelector('#autoResumeEnabled').checked;
                config.AutoSkipIntro = document.querySelector('#autoSkipIntro').checked;
                config.AutoSkipOutro = document.querySelector('#autoSkipOutro').checked;
                config.RandomButtonEnabled = document.querySelector('#randomButtonEnabled').checked;
                config.RandomIncludeMovies = document.querySelector('#randomIncludeMovies').checked;
                config.RandomIncludeShows = document.querySelector('#randomIncludeShows').checked;
                config.RandomUnwatchedOnly = document.querySelector('#randomUnwatchedOnly').checked;
                config.ShowFileSizes = document.querySelector('#showFileSizes').checked;
                config.RemoveContinueWatchingEnabled = document.querySelector('#removeContinueWatchingEnabled').checked;

                ApiClient.updatePluginConfiguration(pluginId, config)
                    .then((result) => {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    })
                    .catch(() => {
                        Dashboard.hideLoadingMsg();
                    });
            });
            return false;
        }

        function clearLocalStorage() {
            if (confirm("Are you sure?\n\nThis will reset Jellyfin Enhanced settings for all users to defaults on next load.")) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginId).then((config) => {
                    config.ClearLocalStorageTimestamp = Date.now();
                    ApiClient.updatePluginConfiguration(pluginId, config).then((result) => {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });
            }
        }

        page.addEventListener('pageshow', loadConfig);
        form.addEventListener('submit', saveConfig);
        clearLocalStorageBtn.addEventListener('click', clearLocalStorage);
    })();
</script>
</div>
</body>
</html>